---
service:
  name: flo-callback-gateway

plugins:
  - serverless-domain-manager
  - serverless-webpack

custom:
  defaultAccount: 098786959887
  defaultRegion: us-west-2
  defaultApiUrl: 'https://api-dev.flocloud.co'
  defaultRetryIntervalMs: 1000
  defaultMaxRetryCount: 3
  accountId: ${env:ACCOUNT_ID, self:custom.defaultAccount}
  region: ${opt:region, self:custom.defaultRegion}
  apiUrl: ${env:API_URL, self:custom.defaultApiUrl}
  retryIntervalMs: ${env:RETRY_INTERVAL_MS, self:custom.defaultRetryIntervalMs}
  maxRetryCount: ${env:MAX_RETRY_COUNT, self:custom.defaultMaxRetryCount}
  customDomain:
    domainName: ${env:CUSTOM_DOMAIN, 'callback.flocloud.co'}
    basePath: ''
    stage: ${opt:stage}
    certificateName: ${env:CERT_NAME, '*.flocloud.co'}
    createRoute53Record: false

provider:
  name: aws
  runtime: nodejs12.x
  region: ${self:custom.region}
  # Always append to this list, do not change the order. CloudFormation
  # objects generated by this structure are named according to the order they
  # appear in this list

  logs:
    restApi:
      role: arn:aws:iam::${self:custom.accountId}:role/APIGatewayPushToCloudWatchLogs
  usagePlan:
    throttle:
      burstLimit: 100
      rateLimit: 10
  environment:
    API_URL: ${self:custom.apiUrl}
    RETRY_INTERVAL_MS: ${self:custom.retryIntervalMs}
    MAX_RETRY_COUNT: ${self:custom.maxRetryCount}

functions:
  twilioVoiceWebhook:
    handler: src/handler.handler
    events:
      - http:
          path: /twilio/voice/{userId}/{incidentId}
          method: post
          integration: LAMBDA_PROXY
          request:
            parameters:
              paths:
                userId: true
                incidentId: true

# you can add CloudFormation resource templates here
# resources:
#   Resources:
#     NewResource:
#       Type: AWS::S3::Bucket
#       Properties:
#         BucketName: my-new-bucket
#   Outputs:
#      NewOutput:
#        Description: "Description for the output"
#        Value: "Some output value"
