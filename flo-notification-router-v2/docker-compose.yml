version: '3'

services:
  app: &app
    image: "${CI_REGISTRY_IMAGE:-registry.gitlab.com/flotechnologies/app}:latest"
    build:
      context: .
      dockerfile: Dockerfile.run
      args:
        CI_REGISTRY_IMAGE: "${CI_REGISTRY_IMAGE}"
        TAG: "deps-${DEPENDENCIES_SHORT_CHECKSUM}"
        CI_COMMIT_SHA: "${CI_COMMIT_SHA:-none}"
        CI_COMMIT_MESSAGE: "${CI_COMMIT_MESSAGE:-none of foo bar}"
        COMMIT_TIME: "${COMMIT_TIME:-none}"
    volumes:
      - ./creds:/app/creds
  # This is used to automatically tag the image with CI_PIPELINE_ID
  app-tag:
    entrypoint: "true"
    image: "${CI_REGISTRY_IMAGE:-registry.gitlab.com/flotechnologies/app}:${CI_PIPELINE_ID:-latest}"
    ports: []
    <<: *app


