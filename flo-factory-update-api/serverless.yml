---
service:
  name: flo-factory-update-api

plugins:
  - serverless-domain-manager
  - serverless-webpack

custom:
  defaultAccount: 098786959887
  defaultRegion: us-west-2
  accountId: ${env:ACCOUNT_ID, self:custom.defaultAccount}
  region: ${opt:region, self:custom.defaultRegion}
  apiUrl: ${env:API_URL}
  apiToken: ${env:API_TOKEN}
  customDomain:
    domainName: ${env:CUSTOM_DOMAIN, 'api-flm.flocloud.co'}
    basePath: ''
    stage: ${opt:stage}
    certificateName: ${env:CERT_NAME, '*.flocloud.co'}
    createRoute53Record: false

provider:
  name: aws
  runtime: nodejs12.x
  region: ${self:custom.region}
  # Always append to this list, do not change the order. CloudFormation
  # objects generated by this structure are named according to the order they
  # appear in this list
  apiKeys:
    - ${opt:stage}-flo-factory-update-api-warehouse
    - ${opt:stage}-flo-factory-update-api-moen-test
    - ${opt:stage}-flo-factory-update-api-flo-internal
    - ${opt:stage}-flo-factory-update-api-flo-office
    - ${opt:stage}-flo-factory-update-api-personal-alex
    - ${opt:stage}-flo-factory-update-api-personal-cihan
    - ${opt:stage}-flo-factory-update-api-personal-daniel
    - ${opt:stage}-flo-factory-update-api-personal-helmut
    - ${opt:stage}-flo-factory-update-api-runscope
    - ${opt:stage}-flo-factory-update-api-personal-vince
  logs:
    restApi:
      role: arn:aws:iam::${self:custom.accountId}:role/APIGatewayPushToCloudWatchLogs
  usagePlan:
    throttle:
      burstLimit: 100
      rateLimit: 10
  environment:
    API_URL: ${self:custom.apiUrl}
    API_TOKEN: ${self:custom.apiToken}
  resourcePolicy:
    - Effect: Allow
      Principal: '*'
      Action: execute-api:Invoke
      Resource:
        - execute-api:/*/*/*
    - Effect: Deny
      Principal: '*'
      Action: execute-api:Invoke
      Resource:
        - execute-api:/*/*/*
      Condition:
        NotIpAddress:
          aws:SourceIp:
            - '108.60.116.94/32'    # Flo Office
            - '74.196.77.77/32'     # Warehouse
            - '72.196.131.40/32'    # Moen PM Home - Testing
            - '70.227.91.17/32'     # Cihan Home - Testing
            - '76.171.211.14/32'    # Daniel Home - Testing
            - '181.13.81.49/32'     # Gabriel Home - Testing
            - '66.215.231.234/32'   # Sebastien Home - Testing
            - '104.59.145.239/32'   # Helmut - Testing
            - '76.86.241.229/32'    # Alex - Testing
            - '172.112.107.108/32'  # Vince - Testing

functions:
  hello:
    handler: src/handler.handler
    events:
      - http:
          path: qrcode
          method: post
          private: true

# you can add CloudFormation resource templates here
# resources:
#   Resources:
#     NewResource:
#       Type: AWS::S3::Bucket
#       Properties:
#         BucketName: my-new-bucket
#   Outputs:
#      NewOutput:
#        Description: "Description for the output"
#        Value: "Some output value"
